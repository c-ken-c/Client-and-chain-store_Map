<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <title>å®¢æˆ¶ Ã— é€£é–åº— å¯†åº¦åˆ†æ</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body {
      margin: 0;
      font-family: Arial, "Microsoft JhengHei", sans-serif;
    }

    h2 {
      margin: 8px 0;
    }

    .container {
      display: grid;
      grid-template-columns: 420px 1fr;
      height: 100vh;
    }

    .panel {
      padding: 10px;
      overflow-y: auto;
      border-right: 1px solid #ccc;
    }

    textarea, input, button {
      width: 100%;
      margin-bottom: 6px;
      padding: 6px;
      font-size: 14px;
    }

    button {
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 4px;
    }

    button:hover {
      background: #0056b3;
    }

    #map {
      height: 100%;
    }

    .ok { color: green; }
    .fail { 
      color: #888;
      font-size: 13px;
    }
    .small { 
      font-size: 12px; 
      color: #1e90ff;
      margin-left: 8px;
    }
    hr { margin: 10px 0; }

    /* åœ–ä¾‹æ¨£å¼ */
    .legend {
      background: white;
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      margin-bottom: 10px;
    }

    .legend-title {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }

    .legend-circle {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 8px;
      border: 2px solid rgba(0,0,0,0.3);
    }

    .customer-marker {
      background: #3388ff;
    }

    .store-marker {
      background: #ff3333;
    }

    .legend-text {
      font-size: 13px;
    }

    /* é™¤éŒ¯é¢æ¿ */
    .debug-section {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      font-size: 12px;
      font-family: monospace;
      max-height: 200px;
      overflow-y: auto;
    }

    .debug-title {
      font-weight: bold;
      color: #666;
      margin-bottom: 5px;
    }

    .debug-item {
      padding: 3px 0;
      border-bottom: 1px solid #ddd;
    }
  </style>
</head>

<body>
<div class="container">
  <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
  <div class="panel">
    <!-- åœ–ä¾‹èªªæ˜ -->
    <div class="legend">
      <div class="legend-title">ğŸ“Š åœ°åœ–åœ–ä¾‹</div>
      <div class="legend-item">
        <div class="legend-circle customer-marker"></div>
        <span class="legend-text">å®¢æˆ¶åœ°å€</span>
      </div>
      <div class="legend-item">
        <div class="legend-circle store-marker"></div>
        <span class="legend-text">é€£é–åº—ä½ç½®</span>
      </div>
    </div>

    <h2>ğŸ“ å®¢æˆ¶åœ°å€ï¼ˆä¸€è¡Œä¸€ç­†ï¼‰</h2>
    <textarea id="customerInput" rows="10"></textarea>

    <h2>ğŸª é€£é–åº—é—œéµå­—</h2>
    <input id="keywordInput" placeholder="ä¾‹å¦‚ï¼šæŒ¯å®‡äº”é‡‘" />

    <button onclick="runAnalysis()">ğŸ” åŸ·è¡Œåˆ†æ</button>

    <hr>

    <h2>ğŸ§¾ å®¢æˆ¶åœ°å€ Geocoding</h2>
    <div id="customerLog"></div>

    <hr>

    <h2>ğŸª é€£é–åº—æœå°‹</h2>
    <div id="storeLog"></div>

    <!-- é™¤éŒ¯è³‡è¨Š -->
    <div class="debug-section" id="debugSection" style="display:none;">
      <div class="debug-title">ğŸ› é™¤éŒ¯è³‡è¨Š</div>
      <div id="debugLog"></div>
    </div>
  </div>

  <!-- å³å´åœ°åœ– -->
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  /* ========= åœ°åœ–åˆå§‹åŒ– ========= */
  const map = L.map("map").setView([23.7, 121], 7);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "Â© OpenStreetMap"
  }).addTo(map);

  const customerLayer = L.layerGroup().addTo(map);
  const storeLayer = L.layerGroup().addTo(map);

  // é™¤éŒ¯ç”¨çš„å…¨åŸŸé™£åˆ—
  let debugInfo = [];

  function addDebug(msg) {
    debugInfo.push(msg);
    console.log('[DEBUG]', msg);
  }

  function showDebug() {
    const debugSection = document.getElementById('debugSection');
    const debugLog = document.getElementById('debugLog');
    
    if (debugInfo.length > 0) {
      debugSection.style.display = 'block';
      debugLog.innerHTML = debugInfo.map(msg => 
        `<div class="debug-item">${msg}</div>`
      ).join('');
    }
  }

  function clearDebug() {
    debugInfo = [];
    document.getElementById('debugSection').style.display = 'none';
    document.getElementById('debugLog').innerHTML = '';
  }

  /* ========= å·¥å…·å‡½å¼ ========= */
  function sleep(ms) {
    return new Promise(r => setTimeout(r, ms));
  }

  function cleanAddress(line) {
    if (line.includes("ï¼š")) {
      return line.split("ï¼š")[1].trim();
    }
    return line.trim();
  }

  /* ========= ä¸»æµç¨‹ ========= */
  async function runAnalysis() {
    clearDebug();
    
    // é©—è­‰é—œéµå­—ä¸å¯ç‚ºç©º
    const keyword = document.getElementById("keywordInput").value.trim();
    if (!keyword) {
      alert("è«‹è¼¸å…¥é€£é–åº—é—œéµå­—ï¼");
      return;
    }

    addDebug(`é–‹å§‹åˆ†æ - é—œéµå­—: ${keyword}`);

    customerLayer.clearLayers();
    storeLayer.clearLayers();

    document.getElementById("customerLog").innerHTML = "";
    document.getElementById("storeLog").innerHTML = "";

    await geocodeCustomers();
    await searchStores();
    
    showDebug();
  }

  /* ========= å®¢æˆ¶åœ°å€ Geocoding ========= */
  async function geocodeCustomers() {
    const lines = document
      .getElementById("customerInput")
      .value
      .split("\n")
      .filter(l => l.trim() !== "");

    addDebug(`å®¢æˆ¶åœ°å€ç¸½æ•¸: ${lines.length}`);

    let successCount = 0;

    for (const line of lines) {
      const addr = cleanAddress(line);
      const query = addr + " å°ç£";

      const url =
        "https://nominatim.openstreetmap.org/search?" +
        new URLSearchParams({
          q: query,
          format: "json",
          limit: 1
        });

      addDebug(`æŸ¥è©¢: ${url}`);

      try {
        const res = await fetch(url, {
          headers: { "Accept-Language": "zh-TW" }
        });
        const data = await res.json();

        addDebug(`å›æ‡‰è³‡æ–™é•·åº¦: ${data.length}`);

        if (data.length > 0) {
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);

          addDebug(`âœ“ ${line} => (${lat}, ${lon})`);

          // è—è‰²åœ“åœˆæ¨™è¨˜å®¢æˆ¶
          const marker = L.circleMarker([lat, lon], {
            radius: 8,
            fillColor: "#3388ff",
            color: "#2277ee",
            weight: 2,
            opacity: 1,
            fillOpacity: 0.7
          })
            .bindPopup(`<b>å®¢æˆ¶åœ°å€</b><br>${line}`)
            .addTo(customerLayer);

          addDebug(`Marker å·²åŠ å…¥åœ–å±¤ï¼Œåº§æ¨™: [${lat}, ${lon}]`);
          successCount++;

          logCustomer(`âœ” ${line} <span class="small">âœ ${query}</span>`, true);
        } else {
          addDebug(`âœ— ${line} => æŸ¥ç„¡çµæœ`);
          logCustomer(`âœ– ${line} <span class="small">âœ ${query}</span>`, false);
        }
      } catch (e) {
        addDebug(`âœ— ${line} => ä¾‹å¤–: ${e.message}`);
        logCustomer(`âœ– ${line} <span class="small">ï¼ˆä¾‹å¤–éŒ¯èª¤ï¼‰</span>`, false);
      }

      await sleep(900); // é¿å…è¢« API æ“‹
    }

    addDebug(`å®¢æˆ¶åœ°å€æˆåŠŸå®šä½: ${successCount}/${lines.length}`);
    addDebug(`customerLayer å…§çš„ Marker æ•¸é‡: ${Object.keys(customerLayer._layers).length}`);
  }

  function logCustomer(text, ok) {
    const div = document.createElement("div");
    div.className = ok ? "ok" : "fail";
    div.innerHTML = text;
    document.getElementById("customerLog").appendChild(div);
  }

  /* ========= é€£é–åº—æœå°‹ï¼ˆOverpassï¼‰ ========= */
  async function searchStores() {
    const keyword = document.getElementById("keywordInput").value.trim();
    if (!keyword) return;

    // ä½¿ç”¨å°ç£çš„ bounding box (å—, è¥¿, åŒ—, æ±)
    const query = `[out:json][timeout:30];
(
  node["name"~"${keyword}",i](21.8,120.0,25.4,122.1);
  way["name"~"${keyword}",i](21.8,120.0,25.4,122.1);
  relation["name"~"${keyword}",i](21.8,120.0,25.4,122.1);
);
out center;`;

    addDebug(`Overpass æŸ¥è©¢: ${keyword}`);
    addDebug(`æŸ¥è©¢èªæ³•é•·åº¦: ${query.length} å­—å…ƒ`);

    document.getElementById("storeLog").innerHTML = "ğŸ” æŸ¥è©¢ä¸­â€¦";

    try {
      const res = await fetch(
        "https://overpass-api.de/api/interpreter",
        { 
          method: "POST", 
          body: query,
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          }
        }
      );

      addDebug(`HTTP ç‹€æ…‹: ${res.status} ${res.statusText}`);

      if (!res.ok) {
        const errorText = await res.text();
        addDebug(`éŒ¯èª¤å›æ‡‰: ${errorText.substring(0, 200)}`);
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }

      const data = await res.json();

      addDebug(`å›æ‡‰å…ƒç´ æ•¸é‡: ${data.elements ? data.elements.length : 0}`);

      if (data.elements && data.elements.length > 0) {
        addDebug(`å‰3ç­†è³‡æ–™: ${JSON.stringify(data.elements.slice(0, 3), null, 2)}`);
      }

      document.getElementById("storeLog").innerHTML = "";

      if (!data.elements || data.elements.length === 0) {
        document.getElementById("storeLog").innerHTML =
          `<div class="fail">âŒ æŸ¥ç„¡ã€Œ${keyword}ã€ç›¸é—œåº—å®¶</div>`;
        addDebug(`æŸ¥ç„¡çµæœ - å¯èƒ½åŸå› : 1) é—œéµå­—ä¸ç¬¦ 2) OSM ç„¡æ­¤è³‡æ–™`);
        return;
      }

      let count = 0;
      data.elements.forEach((el, index) => {
        let lat, lon;

        // è™•ç†ä¸åŒé¡å‹çš„å…ƒç´ 
        if (el.type === 'node') {
          lat = el.lat;
          lon = el.lon;
        } else if (el.center) {
          lat = el.center.lat;
          lon = el.center.lon;
        }

        addDebug(`å…ƒç´  ${index}: type=${el.type}, lat=${lat}, lon=${lon}, name=${el.tags?.name}`);

        if (!lat || !lon || !el.tags || !el.tags.name) {
          addDebug(`å…ƒç´  ${index} è·³é: ç¼ºå°‘å¿…è¦è³‡æ–™`);
          return; // è·³éç„¡æ•ˆè³‡æ–™
        }

        const name = el.tags.name;

        // ç´…è‰²åœ“åœˆæ¨™è¨˜é€£é–åº—
        const marker = L.circleMarker([lat, lon], {
          radius: 6,
          fillColor: "#ff3333",
          color: "#cc0000",
          weight: 2,
          opacity: 1,
          fillOpacity: 0.7
        })
          .bindPopup(`<b>é€£é–åº—</b><br>${name}`)
          .addTo(storeLayer);

        addDebug(`Marker å·²åŠ å…¥: ${name} at [${lat}, ${lon}]`);

        count++;
        document.getElementById("storeLog").innerHTML +=
          `<div class="ok">âœ” ${name}</div>`;
      });

      addDebug(`storeLayer å…§çš„ Marker æ•¸é‡: ${Object.keys(storeLayer._layers).length}`);

      if (count === 0) {
        document.getElementById("storeLog").innerHTML =
          `<div class="fail">âŒ æŸ¥ç„¡ã€Œ${keyword}ã€ç›¸é—œåº—å®¶</div>`;
        addDebug(`é›–æœ‰å›æ‡‰ä½†ç„¡æœ‰æ•ˆè³‡æ–™`);
      } else {
        addDebug(`æˆåŠŸæ¨™è¨˜ ${count} å€‹åº—å®¶`);
      }

    } catch (e) {
      console.error('Overpass API éŒ¯èª¤:', e);
      addDebug(`ä¾‹å¤–éŒ¯èª¤: ${e.message}`);
      document.getElementById("storeLog").innerHTML =
        `<div class="fail">âŒ æŸ¥è©¢å¤±æ•—ï¼š${e.message}</div>`;
    }
  }
</script>
</body>
</html>
