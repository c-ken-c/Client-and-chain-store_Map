<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å°ç£åœ°å€èˆ‡é€£é–åº— GIS åˆ†æç³»çµ±</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>

<style>
body { font-family: Segoe UI, sans-serif; background:#f5f5f5; }
.container { max-width:1400px; margin:auto; padding:20px; }
h1 { text-align:center; margin-bottom:20px; }

.input-section, .debug-panel, .legend {
    background:white; padding:20px; border-radius:8px;
    box-shadow:0 2px 4px rgba(0,0,0,.1);
    margin-bottom:20px;
}

label { font-weight:bold; display:block; margin-bottom:6px; }
textarea, input { width:100%; padding:8px; margin-bottom:12px; }

button {
    padding:12px 30px; font-size:16px;
    background:#007bff; color:white;
    border:none; border-radius:4px; cursor:pointer;
}
button:disabled { background:#ccc; }

#map { height:70vh; border-radius:8px; }

.status { display:none; padding:10px; border-radius:4px; margin-top:10px; }
.status.info { background:#d1ecf1; display:block; }
.status.success { background:#d4edda; display:block; }
.status.error { background:#f8d7da; display:block; }

.debug-container { display:flex; gap:20px; }
.debug-panel { flex:1; max-height:300px; overflow:auto; }
.debug-panel ul { list-style:none; font-size:13px; padding-left:0; }
.debug-panel li { border-bottom:1px solid #eee; padding:4px 0; }
.fail { color:#c0392b; }
</style>
</head>

<body>
<div class="container">

<h1>ğŸ—ºï¸ å°ç£åœ°å€èˆ‡é€£é–åº— GIS åˆ†æç³»çµ±</h1>

<div class="input-section">
<label>å®¢æˆ¶åœ°å€ï¼ˆæ¯è¡Œä¸€ç­†ï¼‰</label>
<textarea id="addresses" placeholder="å°åŒ—å¸‚ä¿¡ç¾©å€å¸‚åºœè·¯1è™Ÿ"></textarea>

<label>é€£é–åº—é—œéµå­—</label>
<input id="keyword" placeholder="æŒ¯å®‡" />

<button id="analyzeBtn">ğŸ” åŸ·è¡Œåˆ†æ</button>
<div id="status" class="status"></div>
</div>

<div id="map"></div>

<div class="debug-container">
<div class="debug-panel">
<h3>ğŸ§¾ å®¢æˆ¶åœ°å€ Geocoding</h3>
<ul id="customer-success"></ul>
<ul id="customer-fail" class="fail"></ul>
</div>

<div class="debug-panel">
<h3>ğŸª é€£é–åº—æœå°‹</h3>
<ul id="store-success"></ul>
<ul id="store-fail" class="fail"></ul>
</div>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>

<script>
let map, customerLayer, storeLayer;

function initMap() {
    map = L.map('map').setView([23.5, 121], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { attribution:'Â© OpenStreetMap' }).addTo(map);
    customerLayer = L.layerGroup().addTo(map);
    storeLayer = L.layerGroup().addTo(map);
}

function showStatus(msg, type='info') {
    const s=document.getElementById('status');
    s.textContent=msg; s.className=`status ${type}`;
}

function resetDebug() {
    ['customer-success','customer-fail','store-success','store-fail']
    .forEach(id=>document.getElementById(id).innerHTML='');
}

async function geocodeAddress(addr) {
    const url=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr+', Taiwan')}&limit=1`;
    const r=await fetch(url,{headers:{'User-Agent':'GIS-App'}});
    const d=await r.json();
    return d[0]?{lat:+d[0].lat, lon:+d[0].lon, name:d[0].display_name}:null;
}

async function searchStores(keyword) {
    const bbox='120.0,21.8,122.1,25.4';
    const q=`[out:json][timeout:25];
    (
      node["shop"]["name"~"${keyword}",i](${bbox});
      way["shop"]["name"~"${keyword}",i](${bbox});
    );out center;`;
    const r=await fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:q});
    const d=await r.json();
    return (d.elements||[]).map(e=>({
        name:e.tags?.name||keyword,
        lat:e.lat||e.center?.lat,
        lon:e.lon||e.center?.lon
    })).filter(s=>s.lat&&s.lon);
}

async function performAnalysis() {
    resetDebug();
    customerLayer.clearLayers();
    storeLayer.clearLayers();

    const addrs=document.getElementById('addresses').value.trim().split('\n').filter(Boolean);
    const keyword=document.getElementById('keyword').value.trim();
    if(!addrs.length||!keyword) return showStatus('è«‹è¼¸å…¥è³‡æ–™','error');

    showStatus('åœ°å€è§£æä¸­â€¦','info');
    const customers=[];

    for(let i=0;i<addrs.length;i++){
        const r=await geocodeAddress(addrs[i]);
        if(r){
            customers.push(r);
            L.circleMarker([r.lat,r.lon],{radius:8,color:'#3388ff'}).addTo(customerLayer);
            customerLayer.eachLayer(l=>l.bindPopup(r.name));
            document.getElementById('customer-success').innerHTML+=
                `<li>âœ… ${addrs[i]}<br><small>${r.lat},${r.lon}</small></li>`;
        } else {
            document.getElementById('customer-fail').innerHTML+=`<li>âŒ ${addrs[i]}</li>`;
        }
        await new Promise(r=>setTimeout(r,800));
    }

    showStatus('æœå°‹é€£é–åº—ä¸­â€¦','info');
    const stores=await searchStores(keyword);

    if(stores.length===0){
        document.getElementById('store-fail').innerHTML='<li>âŒ æŸ¥ç„¡è³‡æ–™</li>';
    } else {
        stores.forEach(s=>{
            L.circleMarker([s.lat,s.lon],{radius:6,color:'#ff3333'}).addTo(storeLayer);
            document.getElementById('store-success').innerHTML+=
                `<li>ğŸª ${s.name}<br><small>${s.lat},${s.lon}</small></li>`;
        });
    }

    const bounds=[...customers.map(c=>[c.lat,c.lon]),...stores.map(s=>[s.lat,s.lon])];
    if(bounds.length) map.fitBounds(bounds,{padding:[40,40]});

    showStatus(`å®Œæˆï¼šå®¢æˆ¶ ${customers.length} ç­†ï½œåº—å®¶ ${stores.length} ç­†`,'success');
}

document.addEventListener('DOMContentLoaded',()=>{
    initMap();
    document.getElementById('analyzeBtn').onclick=performAnalysis;
});
</script>
</body>
</html>
