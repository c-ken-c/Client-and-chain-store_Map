<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<title>å®¢æˆ¶ Ã— é€£é–åº— è·é›¢åˆ†æ</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { margin:0; font-family: Arial, "Microsoft JhengHei", sans-serif; }
.container { display:grid; grid-template-columns:420px 1fr; height:100vh; }
.panel { padding:10px; overflow:auto; border-right:1px solid #ccc; }
#map { height:100%; }

textarea, input, button {
  width:100%; margin-bottom:6px; padding:6px;
}

.ok { color:green; }
.info { color:#1a73e8; }
.fail { color:red; }
.small { font-size:12px; color:#555; }
hr { margin:10px 0; }
</style>
</head>

<body>
<div class="container">
<div class="panel">

<h2>ğŸ—ºï¸ åœ°åœ–æ¨™ç¤ºèªªæ˜</h2>
<div class="small">
ğŸ“ <b>ç´…è‰²åœ–é‡˜</b>ï¼šå®¢æˆ¶åœ°å€<br>
ğŸ”µ <b>è—è‰²åœ“é»</b>ï¼šæŒ¯å®‡äº”é‡‘é–€å¸‚<br>
â­• <b>åœ“åœˆ</b>ï¼š5km / 10km æœå‹™åŠå¾‘
</div>

<hr>

<h2>ğŸ“ å®¢æˆ¶åœ°å€ï¼ˆä¸€è¡Œä¸€ç­†ï¼‰</h2>
<textarea id="customerInput" rows="10"></textarea>

<h2>ğŸª é€£é–åº—é—œéµå­—</h2>
<input id="keywordInput" value="æŒ¯å®‡äº”é‡‘">

<button onclick="runAnalysis()">ğŸ” åŸ·è¡Œåˆ†æ</button>
<button onclick="exportExcel()">ğŸ“¤ åŒ¯å‡º Excel</button>

<hr>

<h2>ğŸ§¾ å®¢æˆ¶åœ°å€ Geocoding</h2>
<div id="customerLog"></div>

<hr>

<h2>ğŸ“Š åˆ†æçµæœ</h2>
<div id="analysisLog"></div>

<hr>

<h2>ğŸª é€£é–åº—æœå°‹</h2>
<div id="storeLog"></div>

</div>
<div id="map"></div>
</div>

<script>
/* ================= åœ°åœ–åˆå§‹åŒ– ================= */
const map = L.map("map").setView([23.7, 121], 7);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution:"Â© OpenStreetMap"
}).addTo(map);

const customerLayer = L.layerGroup().addTo(map);
const storeLayer = L.layerGroup().addTo(map);
const circleLayer = L.layerGroup().addTo(map);

const redIcon = new L.Icon({
  iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
  shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
  iconSize:[25,41], iconAnchor:[12,41]
});

let customers = [];
let stores = [];
let excelData = [];

/* ================= å·¥å…· ================= */
const sleep = ms => new Promise(r => setTimeout(r, ms));

function cleanAddress(line){
  return line.includes("ï¼š") ? line.split("ï¼š")[1].trim() : line.trim();
}

function haversine(lat1, lon1, lat2, lon2){
  const R = 6371;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLon = (lon2-lon1)*Math.PI/180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ================= ä¸»æµç¨‹ ================= */
async function runAnalysis(){
  customers=[]; stores=[]; excelData=[];
  customerLayer.clearLayers();
  storeLayer.clearLayers();
  circleLayer.clearLayers();
  customerLog.innerHTML="";
  storeLog.innerHTML="";
  analysisLog.innerHTML="";

  await geocodeCustomers();
  await searchStores();
  analyzeDistance();
}

/* ================= å®¢æˆ¶ Geocoding ================= */
async function geocodeCustomers(){
  const lines = customerInput.value.split("\n").filter(l=>l.trim());
  for(const line of lines){
    const addr = cleanAddress(line);
    const q = addr + " å°ç£";
    const url = "https://nominatim.openstreetmap.org/search?" +
      new URLSearchParams({ q, format:"json", limit:1 });

    const res = await fetch(url,{ headers:{ "Accept-Language":"zh-TW"}});
    const data = await res.json();

    if(data.length){
      const lat = +data[0].lat;
      const lon = +data[0].lon;
      customers.push({ name:line, lat, lon });

      L.marker([lat,lon],{icon:redIcon})
        .bindPopup(`<b>å®¢æˆ¶</b><br>${line}`)
        .addTo(customerLayer);

      customerLog.innerHTML +=
        `<div class="info">â„¹ï¸ ${line}<div class="small">
        åœ°å€é‡æ–°åˆ¤æ–·ç‚º âœ ${q}</div></div>`;
    } else {
      customerLog.innerHTML +=
        `<div class="fail">âŒ ${line}</div>`;
    }
    await sleep(800);
  }
}

/* ================= æœå°‹æŒ¯å®‡äº”é‡‘ ================= */
async function searchStores(){
  const keyword = keywordInput.value;
  const query = `
[out:json][timeout:25];
area["name"="è‡ºç£"]["admin_level"="2"]->.a;
(node["name"~"${keyword}"](area.a);
 way["name"~"${keyword}"](area.a););
out center;
`;
  const res = await fetch("https://overpass-api.de/api/interpreter",
    {method:"POST", body:query});
  const data = await res.json();

  if(!data.elements.length){
    storeLog.innerHTML = `<div class="fail">âŒ ç„¡è³‡æ–™</div>`;
    return;
  }

  data.elements.forEach(el=>{
    const lat = el.lat || el.center.lat;
    const lon = el.lon || el.center.lon;
    const name = el.tags.name;

    stores.push({ name, lat, lon });

    L.circleMarker([lat,lon],{radius:6})
      .bindPopup(name)
      .addTo(storeLayer);

    storeLog.innerHTML += `<div class="ok">âœ” ${name}</div>`;
  });
}

/* ================= è·é›¢åˆ†æ ================= */
function analyzeDistance(){
  customers.forEach(c=>{
    let min = Infinity;
    let count5=0, count10=0;

    stores.forEach(s=>{
      const d = haversine(c.lat,c.lon,s.lat,s.lon);
      if(d < min) min = d;
      if(d <= 5) count5++;
      if(d <= 10) count10++;
    });

    circleLayer.addLayer(
      L.circle([c.lat,c.lon],{radius:5000, color:"green", fill:false})
    );
    circleLayer.addLayer(
      L.circle([c.lat,c.lon],{radius:10000, color:"orange", fill:false})
    );

    analysisLog.innerHTML += `
    <div>
      <b>${c.name}</b><br>
      æœ€è¿‘é–€å¸‚è·é›¢ï¼š${min.toFixed(2)} km<br>
      5km å…§ï¼š${count5} å®¶ï½œ10km å…§ï¼š${count10} å®¶
    </div><hr>`;

    excelData.push({
      å®¢æˆ¶:c.name,
      æœ€è¿‘é–€å¸‚è·é›¢_km:min.toFixed(2),
      äº”å…¬é‡Œå…§é–€å¸‚æ•¸:count5,
      åå…¬é‡Œå…§é–€å¸‚æ•¸:count10
    });
  });
}

/* ================= åŒ¯å‡º Excel ================= */
function exportExcel(){
  if(!excelData.length){
    alert("å°šç„¡åˆ†æè³‡æ–™");
    return;
  }
  const ws = XLSX.utils.json_to_sheet(excelData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "åˆ†æçµæœ");
  XLSX.writeFile(wb, "å®¢æˆ¶_æŒ¯å®‡äº”é‡‘_è·é›¢åˆ†æ.xlsx");
}
</script>
</body>
</html>
