<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£åœ°å€èˆ‡é€£é–åº— GIS åˆ†æç³»çµ±</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <!-- Leaflet Heatmap CSS -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .input-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
        }

        textarea, input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        button {
            background: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #map {
            width: 100%;
            height: 600px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            display: block;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .legend {
            background: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 50%;
            border: 2px solid #333;
        }

        .blue { background: #3388ff; }
        .red { background: #ff3333; }

        /* Debug é¢æ¿æ¨£å¼ */
        #map {
            height: 70vh;
            margin-bottom: 20px;
        }

        .debug-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .debug-panel {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
        }

        .debug-panel h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #333;
        }

        .debug-panel ul {
            list-style: none;
            font-size: 13px;
        }

        .debug-panel li {
            padding: 6px 0;
            border-bottom: 1px solid #eee;
        }

        .debug-panel .fail {
            color: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ å°ç£åœ°å€èˆ‡é€£é–åº— GIS åˆ†æç³»çµ±</h1>
        
        <div class="input-section">
            <div class="form-group">
                <label for="addresses">å®¢æˆ¶åœ°å€ (ä¸€è¡Œä¸€å€‹åœ°å€):</label>
                <textarea id="addresses" placeholder="ä¾‹å¦‚:&#10;å°åŒ—å¸‚ä¿¡ç¾©å€å¸‚åºœè·¯1è™Ÿ&#10;å°ä¸­å¸‚è¥¿å±¯å€å°ç£å¤§é“ä¸‰æ®µ99è™Ÿ&#10;é«˜é›„å¸‚å‰é®å€ä¸­å±±äºŒè·¯5è™Ÿ"></textarea>
            </div>

            <div class="form-group">
                <label for="keyword">é€£é–åº—é—œéµå­—:</label>
                <input type="text" id="keyword" placeholder="ä¾‹å¦‚: 7-11, å…¨å®¶, æ˜Ÿå·´å…‹">
            </div>

            <button id="analyzeBtn">ğŸ” åŸ·è¡Œåˆ†æ</button>
            
            <div id="status" class="status"></div>
        </div>

        <div class="legend">
            <h3 style="margin-bottom: 10px;">åœ–ä¾‹èªªæ˜</h3>
            <div class="legend-item">
                <div class="legend-color blue"></div>
                <span>å®¢æˆ¶åœ°å€</span>
            </div>
            <div class="legend-item">
                <div class="legend-color red"></div>
                <span>é€£é–åº—ä½ç½®</span>
            </div>
        </div>

        <div id="map"></div>

        <!-- Debug é¢æ¿ -->
        <div class="debug-container">
            <div class="debug-panel">
                <h3>ğŸ§¾ å®¢æˆ¶åœ°å€ Geocoding Debug</h3>
                <ul id="customer-success"></ul>
                <ul id="customer-fail"></ul>
            </div>

            <div class="debug-panel">
                <h3>ğŸª é€£é–åº—æœå°‹ Debug</h3>
                <ul id="store-success"></ul>
                <ul id="store-fail"></ul>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- Leaflet Heatmap Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>

    <script>
        // ==================== å…¨åŸŸè®Šæ•¸ ====================
        let map;
        let customerLayer;
        let storeLayer;
        let customerHeatLayer;
        let storeHeatLayer;

        // ==================== åˆå§‹åŒ–åœ°åœ– ====================
        function initMap() {
            // å»ºç«‹åœ°åœ–ï¼Œä¸­å¿ƒé»è¨­åœ¨å°ç£
            map = L.map('map').setView([23.5, 121], 8);

            // åŠ å…¥ OpenStreetMap åœ–å±¤
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);

            // å»ºç«‹åœ–å±¤ç¾¤çµ„
            customerLayer = L.layerGroup().addTo(map);
            storeLayer = L.layerGroup().addTo(map);
        }

        // ==================== ç‹€æ…‹é¡¯ç¤º ====================
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // ==================== åœ°ç†ç·¨ç¢¼ (åœ°å€è½‰ç¶“ç·¯åº¦) ====================
        async function geocodeAddress(address) {
            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Taiwan')}&limit=1`;
                
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'GIS-Analysis-App'
                    }
                });

                const data = await response.json();

                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon),
                        display_name: data[0].display_name
                    };
                }
                return null;
            } catch (error) {
                console.error(`åœ°å€ç·¨ç¢¼å¤±æ•—: ${address}`, error);
                return null;
            }
        }

        // ==================== æœå°‹é€£é–åº— (Overpass API) ====================
        async function searchStores(keyword) {
            try {
                // Overpass API æŸ¥è©¢èªæ³•
                const query = `
                    [out:json][timeout:25];
                    area["ISO3166-1"="TW"]->.taiwan;
                    (
                        node["name"~"${keyword}",i](area.taiwan);
                        way["name"~"${keyword}",i](area.taiwan);
                    );
                    out center;
                `;

                const url = 'https://overpass-api.de/api/interpreter';
                
                const response = await fetch(url, {
                    method: 'POST',
                    body: query
                });

                const data = await response.json();

                const stores = [];
                
                if (data.elements) {
                    for (const element of data.elements) {
                        let lat, lon;
                        
                        if (element.type === 'node') {
                            lat = element.lat;
                            lon = element.lon;
                        } else if (element.center) {
                            lat = element.center.lat;
                            lon = element.center.lon;
                        }

                        if (lat && lon) {
                            stores.push({
                                name: element.tags.name || keyword,
                                lat: lat,
                                lon: lon
                            });
                        }
                    }
                }

                return stores;
            } catch (error) {
                console.error('åº—å®¶æœå°‹å¤±æ•—:', error);
                return [];
            }
        }

        // ==================== åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºå®¢æˆ¶åœ°å€ ====================
        function displayCustomers(customers) {
            customerLayer.clearLayers();

            const heatPoints = [];

            customers.forEach(customer => {
                if (customer.lat && customer.lon) {
                    // å»ºç«‹è—è‰² Marker
                    const marker = L.circleMarker([customer.lat, customer.lon], {
                        color: '#3388ff',
                        fillColor: '#3388ff',
                        fillOpacity: 0.7,
                        radius: 8
                    });

                    marker.bindPopup(`<b>å®¢æˆ¶åœ°å€</b><br>${customer.display_name || 'åœ°å€'}`);
                    marker.addTo(customerLayer);

                    // åŠ å…¥ç†±åŠ›åœ–è³‡æ–™
                    heatPoints.push([customer.lat, customer.lon, 1]);
                }
            });

            // ç§»é™¤èˆŠçš„ç†±åŠ›åœ–
            if (customerHeatLayer) {
                map.removeLayer(customerHeatLayer);
            }

            // å»ºç«‹å®¢æˆ¶ç†±åŠ›åœ–
            if (heatPoints.length > 0) {
                customerHeatLayer = L.heatLayer(heatPoints, {
                    radius: 25,
                    blur: 35,
                    maxZoom: 17,
                    max: 1.0,
                    gradient: {
                        0.0: 'blue',
                        0.5: 'cyan',
                        1.0: 'lime'
                    }
                }).addTo(map);
            }
        }

        // ==================== åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºé€£é–åº— ====================
        function displayStores(stores) {
            storeLayer.clearLayers();

            const heatPoints = [];

            stores.forEach(store => {
                if (store.lat && store.lon) {
                    // å»ºç«‹ç´…è‰² Marker
                    const marker = L.circleMarker([store.lat, store.lon], {
                        color: '#ff3333',
                        fillColor: '#ff3333',
                        fillOpacity: 0.7,
                        radius: 6
                    });

                    marker.bindPopup(`<b>${store.name}</b>`);
                    marker.addTo(storeLayer);

                    // åŠ å…¥ç†±åŠ›åœ–è³‡æ–™
                    heatPoints.push([store.lat, store.lon, 1]);
                }
            });

            // ç§»é™¤èˆŠçš„ç†±åŠ›åœ–
            if (storeHeatLayer) {
                map.removeLayer(storeHeatLayer);
            }

            // å»ºç«‹åº—å®¶ç†±åŠ›åœ–
            if (heatPoints.length > 0) {
                storeHeatLayer = L.heatLayer(heatPoints, {
                    radius: 20,
                    blur: 30,
                    maxZoom: 17,
                    max: 1.0,
                    gradient: {
                        0.0: 'yellow',
                        0.5: 'orange',
                        1.0: 'red'
                    }
                }).addTo(map);
            }
        }

        // ==================== è‡ªå‹•ç¸®æ”¾åœ°åœ–è‡³æ‰€æœ‰æ¨™è¨˜ ====================
        function fitMapToMarkers(customers, stores) {
            const bounds = [];

            customers.forEach(c => {
                if (c.lat && c.lon) {
                    bounds.push([c.lat, c.lon]);
                }
            });

            stores.forEach(s => {
                if (s.lat && s.lon) {
                    bounds.push([s.lat, s.lon]);
                }
            });

            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        // ==================== ä¸»è¦åˆ†ææµç¨‹ ====================
        async function performAnalysis() {
            const addressesText = document.getElementById('addresses').value.trim();
            const keyword = document.getElementById('keyword').value.trim();
            const analyzeBtn = document.getElementById('analyzeBtn');

            // é©—è­‰è¼¸å…¥
            if (!addressesText) {
                showStatus('è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹å®¢æˆ¶åœ°å€', 'error');
                return;
            }

            if (!keyword) {
                showStatus('è«‹è¼¸å…¥é€£é–åº—é—œéµå­—', 'error');
                return;
            }

            // åœç”¨æŒ‰éˆ•
            analyzeBtn.disabled = true;
            showStatus('æ­£åœ¨è™•ç†ä¸­ï¼Œè«‹ç¨å€™...', 'info');

            try {
                // æ­¥é©Ÿ 1: è™•ç†å®¢æˆ¶åœ°å€
                const addresses = addressesText.split('\n').filter(addr => addr.trim());
                showStatus(`æ­£åœ¨åœ°ç†ç·¨ç¢¼ ${addresses.length} å€‹åœ°å€...`, 'info');

                const customers = [];
                for (let i = 0; i < addresses.length; i++) {
                    const address = addresses[i].trim();
                    showStatus(`åœ°ç†ç·¨ç¢¼ä¸­ (${i + 1}/${addresses.length}): ${address}`, 'info');
                    
                    const result = await geocodeAddress(address);
                    
                    if (result) {
                        customers.push(result);
                    } else {
                        console.warn(`ç„¡æ³•ç·¨ç¢¼åœ°å€: ${address}`);
                    }

                    // é¿å…è«‹æ±‚éå¿« (Nominatim æœ‰é€Ÿç‡é™åˆ¶)
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                showStatus(`æˆåŠŸç·¨ç¢¼ ${customers.length}/${addresses.length} å€‹åœ°å€`, 'info');

                // æ­¥é©Ÿ 2: æœå°‹é€£é–åº—
                showStatus(`æ­£åœ¨æœå°‹é—œéµå­—: ${keyword}...`, 'info');
                const stores = await searchStores(keyword);
                showStatus(`æ‰¾åˆ° ${stores.length} å€‹åº—å®¶`, 'info');

                // æ­¥é©Ÿ 3: é¡¯ç¤ºåœ¨åœ°åœ–ä¸Š
                if (customers.length > 0) {
                    displayCustomers(customers);
                }

                if (stores.length > 0) {
                    displayStores(stores);
                }

                // æ­¥é©Ÿ 4: è‡ªå‹•ç¸®æ”¾
                fitMapToMarkers(customers, stores);

                showStatus(`âœ… åˆ†æå®Œæˆ! å®¢æˆ¶: ${customers.length} å€‹ | åº—å®¶: ${stores.length} å€‹`, 'success');

            } catch (error) {
                console.error('åˆ†æéç¨‹ç™¼ç”ŸéŒ¯èª¤:', error);
                showStatus('åˆ†æå¤±æ•—ï¼Œè«‹æŸ¥çœ‹ console å–å¾—æ›´å¤šè³‡è¨Š', 'error');
            } finally {
                analyzeBtn.disabled = false;
            }
        }

        // ==================== äº‹ä»¶ç›£è½ ====================
        document.addEventListener('DOMContentLoaded', () => {
            initMap();

            document.getElementById('analyzeBtn').addEventListener('click', performAnalysis);
        });
    </script>
</body>
</html>
