<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <title>å®¢æˆ¶ Ã— é€£é–åº— å¯†åº¦åˆ†æ</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body {
      margin: 0;
      font-family: Arial, "Microsoft JhengHei", sans-serif;
    }

    h2 {
      margin: 12px 0 8px 0;
      font-size: 16px;
    }

    .legend-inline {
      display: inline-block;
      margin-left: 8px;
      font-size: 13px;
      color: #666;
      font-weight: normal;
    }

    .container {
      display: grid;
      grid-template-columns: 450px 1fr;
      height: 100vh;
    }

    .panel {
      padding: 10px;
      overflow-y: auto;
      border-right: 1px solid #ccc;
    }

    textarea, input, button {
      width: 100%;
      margin-bottom: 6px;
      padding: 6px;
      font-size: 14px;
    }

    textarea {
      resize: vertical;
    }

    button {
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 4px;
    }

    button:hover {
      background: #0056b3;
    }

    #map {
      height: 100%;
    }

    .ok { color: green; }
    .fail { 
      color: #888;
      font-size: 13px;
    }
    .small { 
      font-size: 12px; 
      color: #1e90ff;
      margin-left: 8px;
    }
    hr { margin: 10px 0; }

    /* é™¤éŒ¯é¢æ¿ */
    .debug-section {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      font-size: 12px;
      font-family: monospace;
      max-height: 200px;
      overflow-y: auto;
    }

    .debug-title {
      font-weight: bold;
      color: #666;
      margin-bottom: 5px;
    }

    .debug-item {
      padding: 3px 0;
      border-bottom: 1px solid #ddd;
    }

    .tip-box {
      background: #fff3cd;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 13px;
    }
  </style>
</head>

<body>
<div class="container">
  <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
  <div class="panel">
    <h2>ğŸ“ å®¢æˆ¶åœ°å€ (ä¸€è¡Œä¸€ç­†) <span class="legend-inline">åœ–ä¾‹: ğŸ”µ è—è‰²åœ“é»</span></h2>
    <textarea id="customerInput" rows="8"></textarea>

    <h2>ğŸª é€£é–åº—åœ°å€ (ä¸€è¡Œä¸€ç­†) <span class="legend-inline">åœ–ä¾‹: ğŸ”´ ç´…è‰²åœ“é» + 3kmæ·¡ç´…åœˆ</span></h2>
    <textarea id="storeAddressInput" rows="6"></textarea>

    <h2>ğŸª é€£é–åº—é—œéµå­— <span class="legend-inline">åœ–ä¾‹: ğŸŸ¢ ç¶ è‰²åœ“é» + 3kmæ·¡ç¶ åœˆ</span></h2>
    <input id="keywordInput" placeholder="ä¾‹å¦‚ï¼š7-11, å…¨å®¶, éº¥ç•¶å‹" />

    <button onclick="runAnalysis()">ğŸ” åŸ·è¡Œåˆ†æ</button>

    <div class="tip-box">
      <b>ğŸ’¡ èªªæ˜ï¼š</b><br>
      â€¢ å®¢æˆ¶åœ°å€ï¼šåªé¡¯ç¤ºè—è‰²åœ“é»<br>
      â€¢ é€£é–åº—åœ°å€ï¼šç´…è‰²åœ“é» + 3km æ·¡ç´…è‰²åœ“åœˆ<br>
      â€¢ é€£é–åº—é—œéµå­—ï¼šç¶ è‰²åœ“é» + 3km æ·¡ç¶ è‰²åœ“åœˆ
    </div>

    <hr>

    <h2>ğŸ§¾ å®¢æˆ¶åœ°å€ Geocoding</h2>
    <div id="customerLog"></div>

    <hr>

    <h2>ğŸª é€£é–åº—åœ°å€ Geocoding</h2>
    <div id="storeAddressLog"></div>

    <hr>

    <h2>ğŸª é€£é–åº—é—œéµå­—æœå°‹</h2>
    <div id="storeKeywordLog"></div>

    <!-- é™¤éŒ¯è³‡è¨Š -->
    <div class="debug-section" id="debugSection" style="display:none;">
      <div class="debug-title">ğŸ› é™¤éŒ¯è³‡è¨Š</div>
      <div id="debugLog"></div>
    </div>
  </div>

  <!-- å³å´åœ°åœ– -->
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  /* ========= åœ°åœ–åˆå§‹åŒ– ========= */
  const map = L.map("map").setView([23.7, 121], 7);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "Â© OpenStreetMap"
  }).addTo(map);

  const customerLayer = L.layerGroup().addTo(map);
  const storeAddressLayer = L.layerGroup().addTo(map);
  const storeKeywordLayer = L.layerGroup().addTo(map);

  // é™¤éŒ¯ç”¨çš„å…¨åŸŸé™£åˆ—
  let debugInfo = [];

  function addDebug(msg) {
    debugInfo.push(msg);
    console.log('[DEBUG]', msg);
  }

  function showDebug() {
    const debugSection = document.getElementById('debugSection');
    const debugLog = document.getElementById('debugLog');
    
    if (debugInfo.length > 0) {
      debugSection.style.display = 'block';
      debugLog.innerHTML = debugInfo.map(msg => 
        `<div class="debug-item">${msg}</div>`
      ).join('');
    }
  }

  function clearDebug() {
    debugInfo = [];
    document.getElementById('debugSection').style.display = 'none';
    document.getElementById('debugLog').innerHTML = '';
  }

  /* ========= å·¥å…·å‡½å¼ ========= */
  function sleep(ms) {
    return new Promise(r => setTimeout(r, ms));
  }

  function cleanAddress(line) {
    if (line.includes("ï¼š")) {
      return line.split("ï¼š")[1].trim();
    }
    return line.trim();
  }

  /* ========= ä¸»æµç¨‹ ========= */
  async function runAnalysis() {
    clearDebug();

    addDebug(`é–‹å§‹åˆ†æ`);

    customerLayer.clearLayers();
    storeAddressLayer.clearLayers();
    storeKeywordLayer.clearLayers();

    document.getElementById("customerLog").innerHTML = "";
    document.getElementById("storeAddressLog").innerHTML = "";
    document.getElementById("storeKeywordLog").innerHTML = "";

    await geocodeCustomers();
    await geocodeStoreAddresses();
    await searchStoresByKeyword();
    
    // è‡ªå‹•ç¸®æ”¾åœ°åœ–ä»¥é¡¯ç¤ºæ‰€æœ‰æ¨™è¨˜
    fitMapToMarkers();
    
    showDebug();
  }

  /* ========= è‡ªå‹•ç¸®æ”¾åœ°åœ– ========= */
  function fitMapToMarkers() {
    const allMarkers = [];
    
    // æ”¶é›†æ‰€æœ‰åœ–å±¤çš„æ¨™è¨˜
    [customerLayer, storeAddressLayer, storeKeywordLayer].forEach(layer => {
      layer.eachLayer(l => {
        if (l.getLatLng) {
          const latLng = l.getLatLng();
          allMarkers.push([latLng.lat, latLng.lng]);
        }
      });
    });
    
    addDebug(`ç¸½å…±æ”¶é›†åˆ° ${allMarkers.length} å€‹æ¨™è¨˜åº§æ¨™`);
    
    if (allMarkers.length > 0) {
      const bounds = L.latLngBounds(allMarkers);
      map.fitBounds(bounds, { 
        padding: [50, 50],
        maxZoom: 12
      });
      addDebug(`åœ°åœ–å·²ç¸®æ”¾`);
      
      setTimeout(() => map.invalidateSize(), 100);
    }
  }

  /* ========= å®¢æˆ¶åœ°å€ Geocoding ========= */
  async function geocodeCustomers() {
    const lines = document
      .getElementById("customerInput")
      .value
      .split("\n")
      .filter(l => l.trim() !== "");

    if (lines.length === 0) return;

    addDebug(`å®¢æˆ¶åœ°å€ç¸½æ•¸: ${lines.length}`);

    let successCount = 0;

    for (const line of lines) {
      const addr = cleanAddress(line);
      let result = null;
      
      result = await tryGeocode(addr + " å°ç£", line);
      
      if (!result) {
        const addrWithoutNumber = addr.replace(/\d+è™Ÿ?$/, '').trim();
        if (addrWithoutNumber !== addr) {
          addDebug(`å˜—è©¦ç§»é™¤é–€ç‰Œè™Ÿç¢¼: ${addrWithoutNumber}`);
          result = await tryGeocode(addrWithoutNumber + " å°ç£", line);
        }
      }
      
      if (!result) {
        const match = addr.match(/(.*?[å¸‚ç¸£].*?[å€é„‰é®å¸‚])/);
        if (match) {
          const districtOnly = match[1];
          addDebug(`å˜—è©¦åªç”¨å€åŸŸ: ${districtOnly}`);
          result = await tryGeocode(districtOnly + " å°ç£", line);
        }
      }

      if (result) {
        successCount++;
        
        // è—è‰²åœ“é»ï¼ˆåŠå¾‘ç¸®å°ç‚ºåŸæœ¬ä¸€åŠï¼‰
        const marker = L.circleMarker([result.lat, result.lon], {
          radius: 3,
          fillColor: "#3388ff",
          color: "#2277ee",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.9
        });
        
        marker.bindPopup(`<b>å®¢æˆ¶åœ°å€</b><br>${line}<br><small>å®šä½: ${result.query}</small>`);
        marker.addTo(customerLayer);
        
        logCustomer(`âœ” ${line} <span class="small">âœ ${result.query}</span>`, true);
      } else {
        logCustomer(`âœ– ${line} <span class="small">âœ ç„¡æ³•å®šä½</span>`, false);
      }

      await sleep(1000);
    }

    addDebug(`å®¢æˆ¶åœ°å€æˆåŠŸå®šä½: ${successCount}/${lines.length}`);
  }

  async function tryGeocode(query, originalLine) {
    const url =
      "https://nominatim.openstreetmap.org/search?" +
      new URLSearchParams({
        q: query,
        format: "json",
        limit: 1,
        countrycodes: "tw"
      });

    addDebug(`æŸ¥è©¢: ${query}`);

    try {
      const res = await fetch(url, {
        headers: { "Accept-Language": "zh-TW" }
      });
      const data = await res.json();

      addDebug(`å›æ‡‰è³‡æ–™é•·åº¦: ${data.length}`);

      if (data.length > 0) {
        const lat = parseFloat(data[0].lat);
        const lon = parseFloat(data[0].lon);

        addDebug(`âœ“ ${originalLine} => (${lat}, ${lon})`);

        return { lat, lon, query };
      }
      
      addDebug(`âœ— æŸ¥ç„¡çµæœ`);
      return null;
      
    } catch (e) {
      addDebug(`âœ— ä¾‹å¤–: ${e.message}`);
      return null;
    }
  }

  function logCustomer(text, ok) {
    const div = document.createElement("div");
    div.className = ok ? "ok" : "fail";
    div.innerHTML = text;
    document.getElementById("customerLog").appendChild(div);
  }

  /* ========= é€£é–åº—åœ°å€ Geocoding ========= */
  async function geocodeStoreAddresses() {
    const lines = document
      .getElementById("storeAddressInput")
      .value
      .split("\n")
      .filter(l => l.trim() !== "");

    if (lines.length === 0) return;

    addDebug(`é€£é–åº—åœ°å€ç¸½æ•¸: ${lines.length}`);

    let successCount = 0;

    for (const line of lines) {
      const addr = cleanAddress(line);
      let result = null;
      
      result = await tryGeocode(addr + " å°ç£", line);
      
      if (!result) {
        const addrWithoutNumber = addr.replace(/\d+è™Ÿ?$/, '').trim();
        if (addrWithoutNumber !== addr) {
          result = await tryGeocode(addrWithoutNumber + " å°ç£", line);
        }
      }
      
      if (!result) {
        const match = addr.match(/(.*?[å¸‚ç¸£].*?[å€é„‰é®å¸‚])/);
        if (match) {
          result = await tryGeocode(match[1] + " å°ç£", line);
        }
      }

      if (result) {
        successCount++;
        
        // ç´…è‰²åœ“é»
        const marker = L.circleMarker([result.lat, result.lon], {
          radius: 3,
          fillColor: "#ff3333",
          color: "#cc0000",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.9
        });
        
        marker.bindPopup(`<b>é€£é–åº—åœ°å€</b><br>${line}`);
        marker.addTo(storeAddressLayer);
        
        // 3km æ·¡ç´…è‰²åœ“åœˆï¼ˆåŠé€æ˜ï¼‰
        L.circle([result.lat, result.lon], {
          radius: 3000,
          color: "#ff6666",
          fillColor: "#ff9999",
          weight: 2,
          opacity: 0.6,
          fillOpacity: 0.2
        }).addTo(storeAddressLayer);
        
        logStoreAddress(`âœ” ${line}`, true);
      } else {
        logStoreAddress(`âœ– ${line} <span class="small">âœ ç„¡æ³•å®šä½</span>`, false);
      }

      await sleep(1000);
    }

    addDebug(`é€£é–åº—åœ°å€æˆåŠŸå®šä½: ${successCount}/${lines.length}`);
  }

  function logStoreAddress(text, ok) {
    const div = document.createElement("div");
    div.className = ok ? "ok" : "fail";
    div.innerHTML = text;
    document.getElementById("storeAddressLog").appendChild(div);
  }

  /* ========= é€£é–åº—é—œéµå­—æœå°‹ ========= */
  async function searchStoresByKeyword() {
    const keyword = document.getElementById("keywordInput").value.trim();
    if (!keyword) return;

    addDebug(`é—œéµå­—æŸ¥è©¢: ${keyword}`);

    document.getElementById("storeKeywordLog").innerHTML = "ğŸ” æŸ¥è©¢ä¸­â€¦";

    let stores = [];
    
    stores = await searchOverpass(keyword, 'area');
    
    if (stores.length === 0) {
      addDebug(`area æŸ¥è©¢ç„¡çµæœï¼Œå˜—è©¦ bbox æ–¹å¼`);
      stores = await searchOverpass(keyword, 'bbox');
    }
    
    if (stores.length === 0 && keyword.includes('äº”é‡‘')) {
      addDebug(`å˜—è©¦æœå°‹ shop=hardware`);
      stores = await searchOverpass(keyword, 'shop');
    }
    
    if (stores.length === 0) {
      addDebug(`å˜—è©¦æœå°‹ amenity`);
      stores = await searchOverpass(keyword, 'amenity');
    }

    document.getElementById("storeKeywordLog").innerHTML = "";

    if (stores.length === 0) {
      document.getElementById("storeKeywordLog").innerHTML =
        `<div class="fail">âŒ æŸ¥ç„¡ã€Œ${keyword}ã€ç›¸é—œåº—å®¶</div>`;
      addDebug(`æ‰€æœ‰ç­–ç•¥éƒ½æŸ¥ç„¡çµæœ`);
      return;
    }

    stores.forEach(store => {
      // ç¶ è‰²åœ“é»
      const marker = L.circleMarker([store.lat, store.lon], {
        radius: 3,
        fillColor: "#33cc33",
        color: "#228822",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.9
      });
      
      marker.bindPopup(`<b>é€£é–åº— (é—œéµå­—)</b><br>${store.name}`);
      marker.addTo(storeKeywordLayer);
      
      // 3km æ·¡ç¶ è‰²åœ“åœˆï¼ˆåŠé€æ˜ï¼‰
      L.circle([store.lat, store.lon], {
        radius: 3000,
        color: "#66cc66",
        fillColor: "#99ff99",
        weight: 2,
        opacity: 0.6,
        fillOpacity: 0.2
      }).addTo(storeKeywordLayer);

      document.getElementById("storeKeywordLog").innerHTML +=
        `<div class="ok">âœ” ${store.name}</div>`;
    });

    addDebug(`æˆåŠŸæ¨™è¨˜ ${stores.length} å€‹é—œéµå­—åº—å®¶`);
  }

  async function searchOverpass(keyword, searchType) {
    let query;
    
    if (searchType === 'area') {
      query = `[out:json][timeout:30];
area["name"="è‡ºç£"]["admin_level"="2"]->.a;
(
  node["name"~"${keyword}",i](area.a);
  way["name"~"${keyword}",i](area.a);
);
out center;`;
    } else if (searchType === 'shop') {
      query = `[out:json][timeout:30];
(
  node["shop"="hardware"]["name"~"${keyword}",i](21.8,120.0,25.4,122.1);
  way["shop"="hardware"]["name"~"${keyword}",i](21.8,120.0,25.4,122.1);
  node["shop"="doityourself"]["name"~"${keyword}",i](21.8,120.0,25.4,122.1);
  way["shop"="doityourself"]["name"~"${keyword}",i](21.8,120.0,25.4,122.1);
);
out center;`;
    } else if (searchType === 'amenity') {
      query = `[out:json][timeout:30];
(
  node["amenity"]["name"~"${keyword}",i](21.8,120.0,25.4,122.1);
  way["amenity"]["name"~"${keyword}",i](21.8,120.0,25.4,122.1);
);
out center;`;
    } else {
      query = `[out:json][timeout:30];
(
  node["name"~"${keyword}",i](21.8,120.0,25.4,122.1);
  way["name"~"${keyword}",i](21.8,120.0,25.4,122.1);
);
out center;`;
    }

    addDebug(`æŸ¥è©¢é¡å‹: ${searchType}`);

    try {
      const res = await fetch(
        "https://overpass-api.de/api/interpreter",
        { 
          method: "POST", 
          body: query,
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          }
        }
      );

      if (!res.ok) return [];

      const data = await res.json();
      addDebug(`å›æ‡‰å…ƒç´ æ•¸é‡ (${searchType}): ${data.elements ? data.elements.length : 0}`);

      const stores = [];

      if (data.elements && data.elements.length > 0) {
        data.elements.forEach(el => {
          let lat, lon;

          if (el.type === 'node') {
            lat = el.lat;
            lon = el.lon;
          } else if (el.center) {
            lat = el.center.lat;
            lon = el.center.lon;
          }

          if (lat && lon && el.tags && el.tags.name) {
            stores.push({
              name: el.tags.name,
              lat: parseFloat(lat),
              lon: parseFloat(lon)
            });
          }
        });
      }

      return stores;

    } catch (e) {
      addDebug(`ä¾‹å¤–éŒ¯èª¤ (${searchType}): ${e.message}`);
      return [];
    }
  }
</script>
</body>
</html>
