<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <title>å®¢æˆ¶ Ã— é€£é–åº— å¯†åº¦åˆ†æ</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body {
      margin: 0;
      font-family: Arial, "Microsoft JhengHei", sans-serif;
    }

    h2 { margin: 8px 0; }

    .container {
      display: grid;
      grid-template-columns: 420px 1fr;
      height: 100vh;
    }

    .panel {
      padding: 10px;
      overflow-y: auto;
      border-right: 1px solid #ccc;
    }

    textarea, input, button {
      width: 100%;
      margin-bottom: 6px;
      padding: 6px;
      font-size: 14px;
    }

    button { cursor: pointer; }

    #map { height: 100%; }

    .ok { color: green; }
    .fail { color: #999; font-size: 12px; }
    .info { color: #1a73e8; font-size: 12px; }
    .small { font-size: 12px; color: #555; }

    hr { margin: 10px 0; }
  </style>
</head>

<body>
<div class="container">

  <!-- å·¦å´ -->
  <div class="panel">

    <h2>ğŸ—ºï¸ åœ–ä¾‹èªªæ˜</h2>
    <div class="small">
      ğŸ”µ <b>è—è‰²åœ“åœˆ</b>ï¼šå®¢æˆ¶ä½ç½®<br>
      ğŸ”´ <b>ç´…è‰²åœ“åœˆ</b>ï¼šé€£é–åº—ä½ç½®
    </div>

    <hr>

    <h2>ğŸ“ å®¢æˆ¶åœ°å€ï¼ˆä¸€è¡Œä¸€ç­†ï¼‰</h2>
    <textarea id="customerInput" rows="10"></textarea>

    <h2>ğŸª é€£é–åº—é—œéµå­—ï¼ˆå¯ç•™ç©ºï¼‰</h2>
    <input id="keywordInput" placeholder="ä¾‹å¦‚ï¼šæŒ¯å®‡äº”é‡‘ï¼ˆå¯ä¸å¡«ï¼‰" />

    <button onclick="runAnalysis()">ğŸ” åŸ·è¡Œåˆ†æ</button>

    <hr>

    <h2>ğŸ§¾ å®¢æˆ¶åœ°å€ Geocoding</h2>
    <div id="customerLog"></div>

    <hr>

    <h2>ğŸª é€£é–åº—æœå°‹</h2>
    <div id="storeLog"></div>
  </div>

  <!-- å³å´åœ°åœ– -->
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ========= åœ°åœ–åˆå§‹åŒ– ========= */
const map = L.map("map").setView([23.7, 121], 7);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

const customerLayer = L.layerGroup().addTo(map);
const storeLayer = L.layerGroup().addTo(map);

/* ========= å·¥å…· ========= */
const sleep = ms => new Promise(r => setTimeout(r, ms));

function cleanAddress(line) {
  return line.includes("ï¼š") ? line.split("ï¼š")[1].trim() : line.trim();
}

/* ========= ä¸»æµç¨‹ ========= */
async function runAnalysis() {
  customerLayer.clearLayers();
  storeLayer.clearLayers();
  customerLog.innerHTML = "";
  storeLog.innerHTML = "";

  await geocodeCustomers();
  await searchStores();
}

/* ========= å®¢æˆ¶ Geocoding ========= */
async function geocodeCustomers() {
  const lines = customerInput.value
    .split("\n")
    .filter(l => l.trim());

  for (const line of lines) {
    const addr = cleanAddress(line);
    const query = addr + " å°ç£";

    const url = "https://nominatim.openstreetmap.org/search?" +
      new URLSearchParams({ q: query, format: "json", limit: 1 });

    try {
      const res = await fetch(url, {
        headers: { "Accept-Language": "zh-TW" }
      });
      const data = await res.json();

      if (data.length) {
        const lat = +data[0].lat;
        const lon = +data[0].lon;

        // å®¢æˆ¶ï¼šè—è‰²åœ“åœˆ
        L.circleMarker([lat, lon], {
          radius: 7,
          color: "#1a73e8",
          fillColor: "#1a73e8",
          fillOpacity: 0.8
        })
        .bindPopup(`<b>å®¢æˆ¶</b><br>${line}`)
        .addTo(customerLayer);

        customerLog.innerHTML += `
          <div class="fail">âœ– ${line}</div>
          <div class="info">âœ ${query}</div>
        `;
      } else {
        customerLog.innerHTML += `
          <div class="fail">âœ– ${line}ï¼ˆç„¡æ³•è§£æï¼‰</div>
        `;
      }
    } catch {
      customerLog.innerHTML += `
        <div class="fail">âœ– ${line}ï¼ˆä¾‹å¤–éŒ¯èª¤ï¼‰</div>
      `;
    }

    await sleep(900);
  }
}

/* ========= é€£é–åº—æœå°‹ ========= */
async function searchStores() {
  const keyword = keywordInput.value.trim();

  if (!keyword) {
    storeLog.innerHTML = `<div class="small">ï¼ˆæœªè¼¸å…¥é—œéµå­—ï¼Œç•¥éæœå°‹ï¼‰</div>`;
    return;
  }

  const query = `
    [out:json][timeout:25];
    area["name"="è‡ºç£"]["admin_level"="2"]->.a;
    (
      node["name"~"${keyword}"](area.a);
      way["name"~"${keyword}"](area.a);
    );
    out center;
  `;

  storeLog.innerHTML = "ğŸ” æŸ¥è©¢ä¸­â€¦";

  try {
    const res = await fetch(
      "https://overpass-api.de/api/interpreter",
      { method: "POST", body: query }
    );
    const data = await res.json();

    storeLog.innerHTML = "";

    if (!data.elements?.length) {
      storeLog.innerHTML = `<div class="fail">âŒ ç„¡è³‡æ–™</div>`;
      return;
    }

    data.elements.forEach(el => {
      const lat = el.lat || el.center.lat;
      const lon = el.lon || el.center.lon;
      const name = el.tags.name;

      // é€£é–åº—ï¼šç´…è‰²åœ“åœˆ
      L.circleMarker([lat, lon], {
        radius: 6,
        color: "#d93025",
        fillColor: "#d93025",
        fillOpacity: 0.8
      })
      .bindPopup(`<b>${name}</b>`)
      .addTo(storeLayer);

      storeLog.innerHTML += `<div class="ok">âœ” ${name}</div>`;
    });
  } catch {
    storeLog.innerHTML = `<div class="fail">âŒ æŸ¥è©¢å¤±æ•—</div>`;
  }
}
</script>
</body>
</html>
